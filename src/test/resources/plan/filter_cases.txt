# No where clause

"select id from user"
{
  "QueryType": "SELECT",
  "Original": "select id from user",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectScatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select id from user where 1 != 1",
    "Query": "select id from user",
    "Table": "user"
  }
}

# Query that always return empty
"select id from user where someColumn = null"
{
  "QueryType": "SELECT",
  "Original": "select id from user where someColumn = null",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectNone",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select id from user where 1 != 1",
    "Query": "select id from user where someColumn = null",
    "Table": "user"
  }
}

# Single table unique vindex route
"select name from user where user.name = 5"
{
  "QueryType": "SELECT",
  "Original": "select name from user where user.name = 5",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectEqualUnique",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select name from user where 1 != 1",
    "Query": "select name from user where user.name = 5",
    "Table": "user",
    "Values": [
      "INT64(5)"
    ],
    "Vindex": "user_index"
  }
}

# Single table unique vindex route, but complex expr
"select name from user where user.name = 5+5"
{
  "QueryType": "SELECT",
  "Original": "select name from user where user.name = 5+5",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectScatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select name from user where 1 != 1",
    "Query": "select name from user where user.name = 5 + 5",
    "Table": "user"
  }
}

# Single table multiple unique vindex match
"select id from music where id = 5 and user_id = 4"
{
  "QueryType": "SELECT",
  "Original": "select id from music where id = 5 and user_id = 4",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectEqualUnique",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select id from music where 1 != 1",
    "Query": "select id from music where id = 5 and user_id = 4",
    "Table": "music",
    "Values": [
      "INT64(4)"
    ],
    "Vindex": "user_index"
  }
}

# Single table complex in clause
"select id from user where name in (col, 'bb')"
{
  "QueryType": "SELECT",
  "Original": "select id from user where name in (col, 'bb')",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectScatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select id from user where 1 != 1",
    "Query": "select id from user where name in (col, 'bb')",
    "Table": "user"
  }
}

# Route with multiple route constraints, SelectIN is the best constraint.
"select name from user where user.col = 5 and user.name in (1, 2)"
{
  "QueryType": "SELECT",
  "Original": "select name from user where user.col = 5 and user.name in (1, 2)",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectIN",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select name from user where 1 != 1",
    "Query": "select name from user where user.col = 5 and user.name in (::__vals)",
    "Table": "user",
    "Values": [
        "(INT64(1), INT64(2))"
    ],
    "Vindex": "user_index"
  }
}

# Route with multiple route constraints and boolean, SelectIN is the best constraint.
"select name from user where user.col = case user.col when 'foo' then true else false end and user.name in (1, 2)"
{
  "QueryType": "SELECT",
  "Original": "select name from user where user.col = case user.col when 'foo' then true else false end and user.name in (1, 2)",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectIN",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select name from user where 1 != 1",
    "Query": "select name from user where user.col = case user.col when 'foo' then true else false end and user.name in (::__vals)",
    "Table": "user",
    "Values": [
        "(INT64(1), INT64(2))"
    ],
    "Vindex": "user_index"
  }
}

# Route with multiple route constraints, SelectEqualUnique is the best constraint.
"select id from user where user.col = 5 and user.id in (1, 2) and user.name = 'aa' and user.id = 1"
{
  "QueryType": "SELECT",
  "Original": "select id from user where user.col = 5 and user.id in (1, 2) and user.name = 'aa' and user.id = 1",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectEqualUnique",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select id from user where 1 != 1",
    "Query": "select id from user where user.col = 5 and user.id in (1, 2) and user.name = 'aa' and user.id = 1",
    "Table": "user",
    "Values": [
      "VARCHAR(\"aa\")"
    ],
    "Vindex": "user_index"
  }
}

# Route with multiple route constraints, SelectEqualUnique is the best constraint, order reversed.
"select id from user where user.id = 1 and user.name = 'aa' and user.id in (1, 2) and user.col = 5"
{
  "QueryType": "SELECT",
  "Original": "select id from user where user.id = 1 and user.name = 'aa' and user.id in (1, 2) and user.col = 5",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectEqualUnique",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select id from user where 1 != 1",
    "Query": "select id from user where user.id = 1 and user.name = 'aa' and user.id in (1, 2) and user.col = 5",
    "Table": "user",
    "Values": [
      "VARCHAR(\"aa\")"
    ],
    "Vindex": "user_index"
  }
}

# Route with OR and AND clause, must parenthesize correctly.
"select id from user where user.id = 1 or user.name = 'aa' and user.id in (1, 2)"
{
  "QueryType": "SELECT",
  "Original": "select id from user where user.id = 1 or user.name = 'aa' and user.id in (1, 2)",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectScatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select id from user where 1 != 1",
    "Query": "select id from user where user.id = 1 or user.name = 'aa' and user.id in (1, 2)",
    "Table": "user"
  }
}

# SELECT with IS NULL
"select user_id from music where user_id is null"
{
  "QueryType": "SELECT",
  "Original": "select user_id from music where user_id is null",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectEqualUnique",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select user_id from music where 1 != 1",
    "Query": "select user_id from music where user_id is null",
    "Table": "music",
    "Values": [
    ],
    "Vindex": "music_user_map"
  }
}

# SELECT with IS NOT NULL
"select id from music where id is not null"
{
  "QueryType": "SELECT",
  "Original": "select id from music where id is not null",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectScatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select id from music where 1 != 1",
    "Query": "select id from music where id is not null",
    "Table": "music"
  }
}

# Single table with unique vindex match and null match
"select id from music where user_id = 4 and id = null"
{
  "QueryType": "SELECT",
  "Original": "select id from music where user_id = 4 and id = null",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectNone",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select id from music where 1 != 1",
    "Query": "select id from music where user_id = 4 and id = null",
    "Table": "music"
  }
}

# Single table with unique vindex match and IN (null)
"select id from music where user_id = 4 and user_id IN (null)"
{
  "QueryType": "SELECT",
  "Original": "select id from music where user_id = 4 and user_id IN (null)",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectNone",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select id from music where 1 != 1",
    "Query": "select id from music where user_id = 4 and user_id in (null)",
    "Table": "music"
  }
}

# Single table with unique vindex match and IN (null, 1, 2)
"select id from music where user_id = 4 and id IN (null, 1, 2)"
{
  "QueryType": "SELECT",
  "Original": "select id from music where user_id = 4 and id IN (null, 1, 2)",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectEqualUnique",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select id from music where 1 != 1",
    "Query": "select id from music where user_id = 4 and id in (null, 1, 2)",
    "Table": "music",
    "Values": [
      "INT64(4)"
    ],
    "Vindex": "user_index"
  }
}

# Single table with unique vindex match and NOT IN (null, 1, 2)
"select id from music where user_id = 4 and id NOT IN (null, 1, 2)"
{
  "QueryType": "SELECT",
  "Original": "select id from music where user_id = 4 and id NOT IN (null, 1, 2)",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectNone",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select id from music where 1 != 1",
    "Query": "select id from music where user_id = 4 and id not in (null, 1, 2)",
    "Table": "music"
  }
}

# Multi-table unique vindex constraint
"select user_extra.id from user join user_extra on user.name = user_extra.user_id where user.name = 5"
{
  "QueryType": "SELECT",
  "Original": "select user_extra.id from user join user_extra on user.name = user_extra.user_id where user.name = 5",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectEqualUnique",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select user_extra.id from user join user_extra on user.name = user_extra.user_id where 1 != 1",
    "Query": "select user_extra.id from user join user_extra on user.name = user_extra.user_id where user.name = 5",
    "Table": "user",
    "Values": [
      "INT64(5)"
    ],
    "Vindex": "user_index"
  }
}

# Multi-table unique vindex constraint on right table
"select user_extra.id from user join user_extra on user.name = user_extra.user_id where user_extra.user_id = 5"
{
  "QueryType": "SELECT",
  "Original": "select user_extra.id from user join user_extra on user.name = user_extra.user_id where user_extra.user_id = 5",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectEqualUnique",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select user_extra.id from user join user_extra on user.name = user_extra.user_id where 1 != 1",
    "Query": "select user_extra.id from user join user_extra on user.name = user_extra.user_id where user_extra.user_id = 5",
    "Table": "user",
    "Values": [
      "INT64(5)"
    ],
    "Vindex": "user_index"
  }
}

# Multi-table unique vindex constraint on left table of left join
"select user_extra.id from user left join user_extra on user.name = user_extra.user_id where user.name = 5"
{
  "QueryType": "SELECT",
  "Original": "select user_extra.id from user left join user_extra on user.name = user_extra.user_id where user.name = 5",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectEqualUnique",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select user_extra.id from user left join user_extra on user.name = user_extra.user_id where 1 != 1",
    "Query": "select user_extra.id from user left join user_extra on user.name = user_extra.user_id where user.name = 5",
    "Table": "user",
    "Values": [
      "INT64(5)"
    ],
    "Vindex": "user_index"
  }
}

# Multi-table unique vindex constraint on left-joined right table
"select user_extra.id from user left join user_extra on user.name = user_extra.user_id where user_extra.user_id = 5"
{
  "QueryType": "SELECT",
  "Original": "select user_extra.id from user left join user_extra on user.name = user_extra.user_id where user_extra.user_id = 5",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectEqualUnique",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select user_extra.id from user left join user_extra on user.name = user_extra.user_id where 1 != 1",
    "Query": "select user_extra.id from user left join user_extra on user.name = user_extra.user_id where user_extra.user_id = 5",
    "Table": "user",
    "Values": [
      "INT64(5)"
    ],
    "Vindex": "user_index"
  }
}

# Multi-route unique vindex constraint
"select user_extra.id from user join user_extra on user.col = user_extra.col where user.name = 5"
{
  "QueryType": "SELECT",
  "Original": "select user_extra.id from user join user_extra on user.col = user_extra.col where user.name = 5",
  "Instructions": {
    "OperatorType": "Join",
    "Variant": "Join",
    "JoinColumnIndexes": [1],
    "TableName": "user_user_extra",
    "Inputs": [
      {
        "OperatorType": "Route",
        "Variant": "SelectEqualUnique",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select user.col from user where 1 != 1",
        "Query": "select user.col from user where user.name = 5",
        "Table": "user",
        "Values": [
          "INT64(5)"
        ],
        "Vindex": "user_index"
      },
      {
        "OperatorType": "Route",
        "Variant": "SelectScatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select user_extra.id from user_extra where 1 != 1",
        "Query": "select user_extra.id from user_extra where user_extra.col = :user_col",
        "Table": "user_extra"
      }
    ]
  }
}

# Multi-route unique vindex route on both routes
"select user_extra.id from user join user_extra on user.col = user_extra.col where user.name = 5 and user_extra.user_id = 5"
{
  "QueryType": "SELECT",
  "Original": "select user_extra.id from user join user_extra on user.col = user_extra.col where user.name = 5 and user_extra.user_id = 5",
  "Instructions": {
    "OperatorType": "Join",
    "Variant": "Join",
    "JoinColumnIndexes": [1],
    "TableName": "user_user_extra",
    "Inputs": [
      {
        "OperatorType": "Route",
        "Variant": "SelectEqualUnique",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select user.col from user where 1 != 1",
        "Query": "select user.col from user where user.name = 5",
        "Table": "user",
        "Values": [
          "INT64(5)"
        ],
        "Vindex": "user_index"
      },
      {
        "OperatorType": "Route",
        "Variant": "SelectEqualUnique",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select user_extra.id from user_extra where 1 != 1",
        "Query": "select user_extra.id from user_extra where user_extra.col = :user_col and user_extra.user_id = 5",
        "Table": "user_extra",
        "Values": [
          "INT64(5)"
        ],
        "Vindex": "user_index"
      }
    ]
  }
}

# Multi-route with cross-route constraint
"select user_extra.id from user join user_extra on user.col = user_extra.col where user_extra.user_id = user.col"
{
  "QueryType": "SELECT",
  "Original": "select user_extra.id from user join user_extra on user.col = user_extra.col where user_extra.user_id = user.col",
  "Instructions": {
    "OperatorType": "Join",
    "Variant": "Join",
    "JoinColumnIndexes": [1],
    "TableName": "user_user_extra",
    "Inputs": [
      {
        "OperatorType": "Route",
        "Variant": "SelectScatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select user.col from user where 1 != 1",
        "Query": "select user.col from user",
        "Table": "user"
      },
      {
        "OperatorType": "Route",
        "Variant": "SelectEqualUnique",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select user_extra.id from user_extra where 1 != 1",
        "Query": "select user_extra.id from user_extra where user_extra.col = :user_col and user_extra.user_id = :user_col",
        "Table": "user_extra",
        "Values": [
          ":user_col"
        ],
        "Vindex": "user_index"
      }
    ]
  }
}

# Multi-route with non-route constraint, should use first route.
"select user_extra.id from user join user_extra on user.col = user_extra.col where 1 = 1"
{
  "QueryType": "SELECT",
  "Original": "select user_extra.id from user join user_extra on user.col = user_extra.col where 1 = 1",
  "Instructions": {
    "OperatorType": "Join",
    "Variant": "Join",
    "JoinColumnIndexes": [1],
    "TableName": "user_user_extra",
    "Inputs": [
      {
        "OperatorType": "Route",
        "Variant": "SelectScatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select user.col from user where 1 != 1",
        "Query": "select user.col from user where 1 = 1",
        "Table": "user"
      },
      {
        "OperatorType": "Route",
        "Variant": "SelectScatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select user_extra.id from user_extra where 1 != 1",
        "Query": "select user_extra.id from user_extra where user_extra.col = :user_col",
        "Table": "user_extra"
      }
    ]
  }
}

# Case preservation test
"select user_extra.Id from user join user_extra on user.nAME = user_extra.User_Id where user.Name = 5"
{
  "QueryType": "SELECT",
  "Original": "select user_extra.Id from user join user_extra on user.nAME = user_extra.User_Id where user.Name = 5",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectEqualUnique",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select user_extra.Id from user join user_extra on user.nAME = user_extra.User_Id where 1 != 1",
    "Query": "select user_extra.Id from user join user_extra on user.nAME = user_extra.User_Id where user.Name = 5",
    "Table": "user",
    "Values": [
      "INT64(5)"
    ],
    "Vindex": "user_index"
  }
}

# subquery of information_schema with itself
"select * from information_schema.a where id in (select * from information_schema.b)"
{
  "QueryType": "SELECT",
  "Original": "select * from information_schema.a where id in (select * from information_schema.b)",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectDBA",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "FieldQuery": "select * from information_schema.a where 1 != 1",
    "Query": "select * from information_schema.a where id in ( select * from information_schema.b )"
  }
}

# Single table equality route with unsigned value
"select id from user where name = 18446744073709551615"
{
  "QueryType": "SELECT",
  "Original": "select id from user where name = 18446744073709551615",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectEqualUnique",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select id from user where 1 != 1",
    "Query": "select id from user where name = 18446744073709551615",
    "Table": "user",
    "Values": [
      "UINT64(18446744073709551615)"
    ],
    "Vindex": "name_user_map"
  }
}

# Single table multiple non-unique vindex match
"select id from user where costly = 'aa' and name = 'bb'"
{
  "QueryType": "SELECT",
  "Original": "select id from user where costly = 'aa' and name = 'bb'",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectEqualUnique",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select id from user where 1 != 1",
    "Query": "select id from user where costly = 'aa' and name = 'bb'",
    "Table": "user",
    "Values": [
      "VARCHAR(\"bb\")"
    ],
    "Vindex": "name_user_map"
  }
}

# Single table multiple non-unique vindex match for IN clause
"select id from user where costly in ('aa', 'bb') and name in ('aa', 'bb')"
{
  "QueryType": "SELECT",
  "Original": "select id from user where costly in ('aa', 'bb') and name in ('aa', 'bb')",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectIN",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select id from user where 1 != 1",
    "Query": "select id from user where costly in ('aa', 'bb') and name in (::__vals)",
    "Table": "user",
    "Values": [
      "(VARCHAR(\"aa\"), VARCHAR(\"bb\"))"
    ],
    "Vindex": "name_user_map"
  }
}

# Route with multiple route constraints and boolean, SelectEqual is the best constraint.
"select (id or col) as val from user where user.col = 5 and user.id in (1, 2) and user.name = 'aa'"
{
  "QueryType": "SELECT",
  "Original": "select (id or col) as val from user where user.col = 5 and user.id in (1, 2) and user.name = 'aa'",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectEqualUnique",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select id or col as val from user where 1 != 1",
    "Query": "select id or col as val from user where user.col = 5 and user.id in (1, 2) and user.name = 'aa'",
    "Table": "user",
    "Values": [
      "VARCHAR(\"aa\")"
    ],
    "Vindex": "name_user_map"
  }
}

# Single table equality route with val arg
"select id from user where name = :a"
{
  "QueryType": "SELECT",
  "Original": "select id from user where name = :a",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectEqualUnique",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select id from user where 1 != 1",
    "Query": "select id from user where name = :a",
    "Table": "user",
    "Values": [
      ":a"
    ],
    "Vindex": "name_user_map"
  }
}

# Route with multiple route constraints, SelectEqual is the best constraint.
"select id from user where user.col = false and user.id in (1, 2) and user.name = 'aa'"
{
  "QueryType": "SELECT",
  "Original": "select id from user where user.col = false and user.id in (1, 2) and user.name = 'aa'",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectEqualUnique",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select id from user where 1 != 1",
    "Query": "select id from user where user.col = false and user.id in (1, 2) and user.name = 'aa'",
    "Table": "user",
    "Values": [
      "VARCHAR(\"aa\")"
    ],
    "Vindex": "name_user_map"
  }
}

# subquery
"select u.m from user_extra join user u where u.name in (select m2 from user where user.name = u.name and user_extra.col = user.col) and u.name in (user_extra.col, 1)"
{
  "QueryType": "SELECT",
  "Original": "select u.m from user_extra join user u where u.name in (select m2 from user where user.name = u.name and user_extra.col = user.col) and u.name in (user_extra.col, 1)",
  "Instructions": {
    "OperatorType": "Join",
    "Variant": "Join",
    "JoinColumnIndexes": [1],
    "TableName": "user_extra_user",
    "Inputs": [
      {
        "OperatorType": "Route",
        "Variant": "SelectScatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select user_extra.col from user_extra where 1 != 1",
        "Query": "select user_extra.col from user_extra",
        "Table": "user_extra"
      },
      {
        "OperatorType": "Route",
        "Variant": "SelectIN",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select u.m from user as u where 1 != 1",
        "Query": "select u.m from user as u where u.name in (::__vals) and u.name in ( select m2 from user where user.name = u.name and user.col = :user_extra_col )",
        "Table": "user",
        "Values": [
          "(:user_extra_col, INT64(1))"
        ],
        "Vindex": "hash"
      }
    ]
  }
}

# ensure subquery reordering gets us a better plan
"select u.m from user_extra join user u where u.name in (select m2 from user where user.name = 5) and u.name = 5"
{
  "QueryType": "SELECT",
  "Original": "select u.m from user_extra join user u where u.name in (select m2 from user where user.name = 5) and u.name = 5",
  "Instructions": {
    "OperatorType": "Join",
    "Variant": "Join",
    "JoinColumnIndexes": [1],
    "TableName": "user_extra_user",
    "Inputs": [
      {
        "OperatorType": "Route",
        "Variant": "SelectScatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select 1 from user_extra where 1 != 1",
        "Query": "select 1 from user_extra",
        "Table": "user_extra"
      },
      {
        "OperatorType": "Route",
        "Variant": "SelectEqualUnique",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select u.m from user as u where 1 != 1",
        "Query": "select u.m from user as u where u.name = 5 and u.name in ( select m2 from user where user.name = 5 )",
        "Table": "user",
        "Values": [
          "INT64(5)"
        ],
        "Vindex": "hash"
      }
    ]
  }
}

# nested subquery
"select u.m from user_extra join user u where u.name in (select m2 from user where user.name = u.name and user_extra.col = user.col and user.name in (select m3 from user_extra where user_extra.user_id = user.name)) and u.name in (user_extra.col, 1)"
{
  "QueryType": "SELECT",
  "Original": "select u.m from user_extra join user u where u.name in (select m2 from user where user.name = u.name and user_extra.col = user.col and user.name in (select m3 from user_extra where user_extra.user_id = user.name)) and u.name in (user_extra.col, 1)",
  "Instructions": {
    "OperatorType": "Join",
    "Variant": "Join",
    "JoinColumnIndexes": [1],
    "TableName": "user_extra_user",
    "Inputs": [
      {
        "OperatorType": "Route",
        "Variant": "SelectScatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select user_extra.col from user_extra where 1 != 1",
        "Query": "select user_extra.col from user_extra",
        "Table": "user_extra"
      },
      {
        "OperatorType": "Route",
        "Variant": "SelectIN",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select u.m from user as u where 1 != 1",
        "Query": "select u.m from user as u where u.name in (::__vals) and u.name in ( select m2 from user where user.name = u.name and user.col = :user_extra_col and user.name in ( select m3 from user_extra where user_extra.user_id = user.name ) )",
        "Table": "user",
        "Values": [
          "(:user_extra_col, INT64(1))"
        ],
        "Vindex": "user_index"
      }
    ]
  }
}

# Correlated subquery in where clause
"select id from user where user.col in (select user_extra.col from user_extra where user_extra.user_id = user.name)"
{
  "QueryType": "SELECT",
  "Original": "select id from user where user.col in (select user_extra.col from user_extra where user_extra.user_id = user.name)",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectScatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select id from user where 1 != 1",
    "Query": "select id from user where user.col in ( select user_extra.col from user_extra where user_extra.user_id = user.name )",
    "Table": "user"
  }
}

# outer and inner subquery route by same int val
"select id from user where name = 5 and user.col in (select user_extra.col from user_extra where user_extra.user_id = 5)"
{
  "QueryType": "SELECT",
  "Original": "select id from user where name = 5 and user.col in (select user_extra.col from user_extra where user_extra.user_id = 5)",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectEqualUnique",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select id from user where 1 != 1",
    "Query": "select id from user where name = 5 and user.col in ( select user_extra.col from user_extra where user_extra.user_id = 5 )",
    "Table": "user",
    "Values": [
      "INT64(5)"
    ],
    "Vindex": "user_index"
  }
}

# outer and inner subquery route by same str val
"select id from user where name = 'aa' and user.col in (select user_extra.col from user_extra where user_extra.user_id = 'aa')"
{
  "QueryType": "SELECT",
  "Original": "select id from user where name = 'aa' and user.col in (select user_extra.col from user_extra where user_extra.user_id = 'aa')",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectEqualUnique",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select id from user where 1 != 1",
    "Query": "select id from user where name = 'aa' and user.col in ( select user_extra.col from user_extra where user_extra.user_id = 'aa' )",
    "Table": "user",
    "Values": [
      "VARCHAR(\"aa\")"
    ],
    "Vindex": "user_index"
  }
}

# outer and inner subquery route by same val arg
"select id from user where name = :a and user.col in (select user_extra.col from user_extra where user_extra.user_id = :a)"
{
  "QueryType": "SELECT",
  "Original": "select id from user where name = :a and user.col in (select user_extra.col from user_extra where user_extra.user_id = :a)",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectEqualUnique",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select id from user where 1 != 1",
    "Query": "select id from user where name = :a and user.col in ( select user_extra.col from user_extra where user_extra.user_id = :a )",
    "Table": "user",
    "Values": [
      ":a"
    ],
    "Vindex": "user_index"
  }
}

# unresolved symbol in inner subquery.
"select id from user where id = :a and user.col in (select user_extra.col from user_extra where user_extra.user_id = :a and foo.id = 1)"
"symbol foo.id not found"

# outer and inner subquery route by same outermost column value
"select id2 from user uu where name in (select name from user where name = uu.name and user.col in (select user_extra.col from user_extra where user_extra.user_id = uu.name))"
{
  "QueryType": "SELECT",
  "Original": "select id2 from user uu where name in (select name from user where name = uu.name and user.col in (select user_extra.col from user_extra where user_extra.user_id = uu.name))",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectScatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select id2 from user as uu where 1 != 1",
    "Query": "select id2 from user as uu where name in ( select name from user where name = uu.name and user.col in ( select user_extra.col from user_extra where user_extra.user_id = uu.name ) )",
    "Table": "user"
  }
}

# cross-shard subquery in IN clause.
# Note the improved Underlying plan as SelectIN.
"select name from user where name in (select col from user)"
{
  "QueryType": "SELECT",
  "Original": "select name from user where name in (select col from user)",
  "Instructions": {
    "OperatorType": "Subquery",
    "Variant": "PulloutIn",
    "Inputs": [
      {
        "OperatorType": "Route",
        "Variant": "SelectScatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select col from user where 1 != 1",
        "Query": "select col from user",
        "Table": "user"
      },
      {
        "OperatorType": "Route",
        "Variant": "SelectIN",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select name from user where 1 != 1",
        "Query": "select name from user where :__sq_has_values1 = 1 and name in (::__vals)",
        "Table": "user",
        "Values": [
          "::__sq1"
        ],
        "Vindex": "hash"
      }
    ]
  }
}

# cross-shard subquery in NOT IN clause.
"select name from user where name not in (select col from user)"
{
  "QueryType": "SELECT",
  "Original": "select name from user where name not in (select col from user)",
  "Instructions": {
    "OperatorType": "Subquery",
    "Variant": "PulloutNotIn",
    "Inputs": [
      {
        "OperatorType": "Route",
        "Variant": "SelectScatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select col from user where 1 != 1",
        "Query": "select col from user",
        "Table": "user"
      },
      {
        "OperatorType": "Route",
        "Variant": "SelectScatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select name from user where 1 != 1",
        "Query": "select name from user where :__sq_has_values1 = 0 or name not in (::__sq1)",
        "Table": "user"
      }
    ]
  }
}

# cross-shard subquery in EXISTS clause.
"select id from user where exists (select col from user)"
{
  "QueryType": "SELECT",
  "Original": "select id from user where exists (select col from user)",
  "Instructions": {
    "OperatorType": "Subquery",
    "Variant": "PulloutExists",
    "Inputs": [
      {
        "OperatorType": "Route",
        "Variant": "SelectScatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select col from user where 1 != 1",
        "Query": "select col from user",
        "Table": "user"
      },
      {
        "OperatorType": "Route",
        "Variant": "SelectScatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select id from user where 1 != 1",
        "Query": "select id from user where :__sq_has_values1",
        "Table": "user"
      }
    ]
  }
}

# cross-shard subquery as expression
"select name from user where name = (select col from user)"
{
  "QueryType": "SELECT",
  "Original": "select name from user where name = (select col from user)",
  "Instructions": {
    "OperatorType": "Subquery",
    "Variant": "PulloutValue",
    "Inputs": [
      {
        "OperatorType": "Route",
        "Variant": "SelectScatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select col from user where 1 != 1",
        "Query": "select col from user",
        "Table": "user"
      },
      {
        "OperatorType": "Route",
        "Variant": "SelectEqualUnique",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select name from user where 1 != 1",
        "Query": "select name from user where name = :__sq1",
        "Table": "user",
        "Values": [
          ":__sq1"
        ],
        "Vindex": "hash"
      }
    ]
  }
}

# multi-level pullout
"select id1 from user where name = (select id2 from user where id2 in (select id3 from user))"
{
  "QueryType": "SELECT",
  "Original": "select id1 from user where name = (select id2 from user where id2 in (select id3 from user))",
  "Instructions": {
    "OperatorType": "Subquery",
    "Variant": "PulloutValue",
    "Inputs": [
      {
        "OperatorType": "Subquery",
        "Variant": "PulloutIn",
        "Inputs": [
          {
            "OperatorType": "Route",
            "Variant": "SelectScatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select id3 from user where 1 != 1",
            "Query": "select id3 from user",
            "Table": "user"
          },
          {
            "OperatorType": "Route",
            "Variant": "SelectScatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select id2 from user where 1 != 1",
            "Query": "select id2 from user where :__sq_has_values1 = 1 and id2 in (::__sq1)",
            "Table": "user"
          }
        ]
      },
      {
        "OperatorType": "Route",
        "Variant": "SelectEqualUnique",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select id1 from user where 1 != 1",
        "Query": "select id1 from user where name = :__sq2",
        "Table": "user",
        "Values": [
          ":__sq2"
        ],
        "Vindex": "hash"
      }
    ]
  }
}

# database() call in where clause.
"select id from user where database()"
{
  "QueryType": "SELECT",
  "Original": "select id from user where database()",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectScatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select id from user where 1 != 1",
    "Query": "select id from user where DATABASE()",
    "Table": "user"
  }
}

# outer and inner subquery route reference the same "uu.id" name
# but they refer to different things. The first reference is to the outermost query,
# and the second reference is to the innermost 'from' subquery.
"select id2 from user uu where id in (select id from user where id = uu.id and user.col in (select col from (select id from user_extra where user_id = 5) uu where uu.user_id = uu.id))"
"unsupported: cross-shard correlated subquery"

# Select with equals null
"select id from music where id = null"
{
  "QueryType": "SELECT",
  "Original": "select id from music where id = null",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectNone",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select id from music where 1 != 1",
    "Query": "select id from music where id = null",
    "Table": "music"
  }
}

# query trying to query two different keyspaces at the same time
"SELECT B.TABLE_NAME FROM INFORMATION_SCHEMA.TABLES AS A, INFORMATION_SCHEMA.COLUMNS AS B WHERE A.TABLE_SCHEMA = 'user' AND A.TABLE_SCHEMA = 'main' AND B.TABLE_NAME = A.TABLE_NAME"
{
  "QueryType": "SELECT",
  "Original": "SELECT B.TABLE_NAME FROM INFORMATION_SCHEMA.TABLES AS A, INFORMATION_SCHEMA.COLUMNS AS B WHERE A.TABLE_SCHEMA = 'user' AND A.TABLE_SCHEMA = 'main' AND B.TABLE_NAME = A.TABLE_NAME",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectDBA",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "FieldQuery": "select B.TABLE_NAME from INFORMATION_SCHEMA.TABLES as A, INFORMATION_SCHEMA.COLUMNS as B where 1 != 1",
    "Query": "select B.TABLE_NAME from INFORMATION_SCHEMA.TABLES as A, INFORMATION_SCHEMA.COLUMNS as B where A.TABLE_SCHEMA = :__vtschemaname and A.TABLE_SCHEMA = :__vtschemaname and B.TABLE_NAME = A.TABLE_NAME",
    "SysTableKeyspaceExpr": [
      "VARBINARY(\"user\")",
      "VARBINARY(\"main\")"
    ]
  }
}

# query trying to query two different keyspaces at the same time
"SELECT B.TABLE_NAME FROM INFORMATION_SCHEMA.TABLES AS A, INFORMATION_SCHEMA.COLUMNS AS B WHERE A.TABLE_SCHEMA = 'user' AND A.TABLE_SCHEMA = 'main' AND B.TABLE_NAME = A.TABLE_NAME"
{
  "QueryType": "SELECT",
  "Original": "SELECT B.TABLE_NAME FROM INFORMATION_SCHEMA.TABLES AS A, INFORMATION_SCHEMA.COLUMNS AS B WHERE A.TABLE_SCHEMA = 'user' AND A.TABLE_SCHEMA = 'main' AND B.TABLE_NAME = A.TABLE_NAME",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectDBA",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "FieldQuery": "select B.TABLE_NAME from INFORMATION_SCHEMA.TABLES as A, INFORMATION_SCHEMA.COLUMNS as B where 1 != 1",
    "Query": "select B.TABLE_NAME from INFORMATION_SCHEMA.TABLES as A, INFORMATION_SCHEMA.COLUMNS as B where A.TABLE_SCHEMA = :__vtschemaname and A.TABLE_SCHEMA = :__vtschemaname and B.TABLE_NAME = A.TABLE_NAME",
    "SysTableKeyspaceExpr": [
      "VARBINARY(\"user\")",
      "VARBINARY(\"main\")"
    ]
  }
}

# information_schema query using database() func
"SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = DATABASE()"
{
  "QueryType": "SELECT",
  "Original": "SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = DATABASE()",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectDBA",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "FieldQuery": "select * from INFORMATION_SCHEMA.TABLES where 1 != 1",
    "Query": "select * from INFORMATION_SCHEMA.TABLES where TABLE_SCHEMA = DATABASE()"
  }
}
